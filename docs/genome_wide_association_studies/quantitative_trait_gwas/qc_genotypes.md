---
sidebar_position: 4
---

# Part 1: Quality control of genotype data

## Calculating summary statistics for the data

The premise of our GWAS is that we have taken a random sample of case and control individuals in the population, and measured their genotypes genome-wide using a microarray approach.  Because of this there are a few quality control checks we ought to do before analysis - and, if there are any artifacts, we will want to remove them from the data before trying to test for association.

:::tip Why do quality control?

Bear in mind that in a GWAS you are running association tests across millions of genetic variants at the same time. If
even a small proportion of variants have data quality issues, this can easily lead to hundreds our thousands of spurious
findings.  You want to avoid this by getting rid of any obvious artifacts beforehand.

:::

The simplest way to assess quality of genotyping data is by looking at the amount of missing genotype calls (or **missingness**) within the data.  This can be assessed at each variant or for each sample.  Variants with high missingness might mean the genotype assays for those variants are poor, while samples with high missingness might be ones that had low DNA quality or quantity, or other problems in collection.

Another useful way to inspect the data is to look at some genetic characteristics, such as the **level of relatedness** between individuals, the **occurence of rare alleles**, and the **heterozygosity** (proportion of genotype calls which are heterozygous) of each individual.  The heterozygosity in particular tells us useful information about the sample (for example, it might highlight samples that have been contaminated with other samples during processing - they would have too much heterozygosity).

Let's start by using plink to calculating missingness.

```
./plink \
--bfile Genotype_data/AMR_genotypes \
--missing \
--out AMR_genotypes
```

This will give you two files in your output directory:

* `AMR_genotypes.imiss`` contains a summary of missing data by sample,
* and `AMR_genotypes.lmiss`` contains a similar summary by variant.

Other summary statistics can be generated by replacing the --missing flag with other flags as shown below:

| Descriptor                   | Flag          | Statistic column           |
| ---------------------------- | ------------- | -------------------------- |
| `missingness`                | `--missing`   | `F_MISS`                   |
| `heterozygosity`             | `--het`       | `OBS_HET` (but see below.) |
| `relatedness`                | `--genome`    | `PI_HAT` (but see below.)  |
| `minor allele frequency`     | `--freq`      | `MAF`                      |
| `Hardy-Weinberg equilibrium` | `--hardy`     | `P`                        |

Once you have generated summaries for each of these descriptors, you can plot these in R. 

For example:
```r
library(tidyverse)

# Read in the PLINK output file 
data = readr::read_table( "AMR_genotypes.lmiss" )
# Provide a filename for the plot output
png(file="AMR.missing_variants.png")

p = (
	ggplot( data, aes( x = F_MISS ) )
	+ geom_histogram( binwidth=0.001 )
	+ labs(
		title = "Missingness (variant)",
		x = "frequency",
		y = "count"
	)
)
print(p)

dev.off()
```

Here is a quick guide to each metric:

### Missingness

'Missingess' is the proportion of missing genotypes.  Let's look at samples first:
```
miss = (
	readr::read_table( "AMR_genotypes.imiss" )
	%>% mutate(
		missingness = F_MISS
	)
)
```

### Heterozygosity

The output file of `--het` lists the observed number of homozygotes (`O(HOM)`) for each sample, and the total number of
non-missing genotypes (`N(NM)`).

Let's use that along with the missingness to plot the rate of missing and heterozygous genotypes per sample:

```
het = (
	readr::read_table( "AMR_genotypes.het" )
	%>% mutate(
		heterozygosity = (`N(NM)` - `O(HOM)`) / `N(NM)`
	)
)
sample_summary = (
	miss
	%>% select( FID, IID, N_MISS, N_GENO, missingness )
	%>% inner_join( het, by = c( "FID", "IID" ))
)
print( sample_summary )

```
...and plot it:
```
(
	ggplot( data = sample_summary )
	+ geom_point( aes( x = missingness, y = heterozygosity ))
)
```

:::tip Challenge

Make a plot like the above for each of the summary statistics.

:::


### Applying filters to the data

The next step will be to apply filters to the dataset using PLINK to exclude variants or samples of low quality. A description of the filters and some recommended thresholds is included below along with an example plink command. These flags can be used individually or together to apply filters to the dataset.

| Filter | Flag | Suggested cutoff | Description |
| ------ | ---- | ------ | ----------- |
| missingness (variant) | `--geno` | `0.1` | Removes variants with<br />a **missing call rate** $> 0.1$ |
| missingness (sample) | `--mind` | `0.1` | Removes samples with<br />a **missing call rate** $> 0.1$ |
| minor allele frequency | `--maf` | `0.01` | Removes variants with<br />a **minor allele frequency** less than 1% |
| Hardy-Weinberg equilibrium | `--hwe` | `0.000001` | Removes variants which have **Hardy-Weinberg<br/>"exact test" p-value** $< 1\times 10^{-6}$ |

To filter variants and samples with genotyping rates below 0.1, and variants with a minor allele frequency less than 0.01, the following command would be used:
```
./plink \
--bfile Genotype_data/AMR_genotypes \
--geno 0.1 \
--mind 0.1 \
--maf 0.01 \
--make-bed \
--out Genotype_data/AMR_genotypes.filtered
```

:::tip Questions

- Does this dataset consist of one chromosome or many? Which one(s)?
- How many individuals were in each dataset?
- How many individuals, and how many variants were excluded by the filters?

:::
