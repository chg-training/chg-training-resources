<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-sequence_data_analysis/building_an_ngs_pipeline/tips_and_tricks">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.20">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><title data-rh="true">Tips and tricks | The CHG training resources</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://chg.ox.ac.uk//chg-training-resources/sequence_data_analysis/building_an_ngs_pipeline/tips_and_tricks/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Tips and tricks | The CHG training resources"><meta data-rh="true" name="description" content="Here is some guidance to help you write your pipeline. Click the links to jump to the relevant"><meta data-rh="true" property="og:description" content="Here is some guidance to help you write your pipeline. Click the links to jump to the relevant"><link data-rh="true" rel="icon" href="/chg-training-resources/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://chg.ox.ac.uk//chg-training-resources/sequence_data_analysis/building_an_ngs_pipeline/tips_and_tricks/"><link data-rh="true" rel="alternate" href="https://chg.ox.ac.uk//chg-training-resources/sequence_data_analysis/building_an_ngs_pipeline/tips_and_tricks/" hreflang="en"><link data-rh="true" rel="alternate" href="https://chg.ox.ac.uk//chg-training-resources/sequence_data_analysis/building_an_ngs_pipeline/tips_and_tricks/" hreflang="x-default"><link rel="stylesheet" href="/chg-training-resources/assets/css/styles.f24e0b7d.css">
<link rel="preload" href="/chg-training-resources/assets/js/runtime~main.2a3d8fab.js" as="script">
<link rel="preload" href="/chg-training-resources/assets/js/main.e5fe2fc6.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/chg-training-resources/"><div class="navbar__logo"><img src="/chg-training-resources/img/CHG_logo_RGB.png" alt="My Site Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/chg-training-resources/img/CHG_logo_negative_RGB.png" alt="My Site Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title text--truncate">Training Resources</b></a><a class="navbar__item navbar__link" href="/chg-training-resources/overview/">Tutorials home</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/chg-training/chg-training-resources" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_dLyj"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_mKqt"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><div class="docPage_ualW"><aside class="theme-doc-sidebar-container docSidebarContainer_UQUJ"><div class="sidebar_RiAD"><nav class="menu thin-scrollbar menu_izAj"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/chg-training-resources/sequence_data_analysis/">Next-generation sequencing</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/chg-training-resources/sequence_data_analysis/sanger_sequence_data/">Analysing Sanger sequence data</a><button aria-label="Toggle the collapsible sidebar category &#x27;Analysing Sanger sequence data&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/chg-training-resources/sequence_data_analysis/introduction_to_next_generation_sequencing_data_analysis/">Analysing paired-end sequencing data</a><button aria-label="Toggle the collapsible sidebar category &#x27;Analysing paired-end sequencing data&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/chg-training-resources/sequence_data_analysis/IGV/">Exploring Reads in IGV</a><button aria-label="Toggle the collapsible sidebar category &#x27;Exploring Reads in IGV&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/chg-training-resources/sequence_data_analysis/building_an_ngs_pipeline/">A sequence data pipelining challenge!</a><button aria-label="Toggle the collapsible sidebar category &#x27;A sequence data pipelining challenge!&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/chg-training-resources/sequence_data_analysis/building_an_ngs_pipeline/Introduction/">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/chg-training-resources/sequence_data_analysis/building_an_ngs_pipeline/pipeline/">The pipeline</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/chg-training-resources/sequence_data_analysis/building_an_ngs_pipeline/tips_and_tricks/">Tips and tricks</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/chg-training-resources/sequence_data_analysis/variant_calling_and_imputation/">Variant calling, phasing and imputation</a><button aria-label="Toggle the collapsible sidebar category &#x27;Variant calling, phasing and imputation&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/chg-training-resources/sequence_data_analysis/sightseeing_tour/">IGV sightseeing tour</a><button aria-label="Toggle the collapsible sidebar category &#x27;IGV sightseeing tour&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_uL0j"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/chg-training-resources/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_kU5B"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/chg-training-resources/sequence_data_analysis/building_an_ngs_pipeline/"><span itemprop="name">A sequence data pipelining challenge!</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Tips and tricks</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_bZGK theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_l22C">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Tips and tricks</h1><p>Here is some guidance to help you write your pipeline. Click the links to jump to the relevant
section.</p><ul><li><a href="/chg-training-resources/sequence_data_analysis/building_an_ngs_pipeline/tips_and_tricks/#getting-started">Wait, what?  How should I start?</a></li><li><a href="#give-me-a-first-rule-hint">Give me a first rule hint?</a></li><li><a href="/chg-training-resources/sequence_data_analysis/building_an_ngs_pipeline/tips_and_tricks/#how-should-i-get-sample-information-in">How should I get sample information in?</a></li><li><a href="/chg-training-resources/sequence_data_analysis/building_an_ngs_pipeline/tips_and_tricks/#how-should-i-run-snakemake">How should I run snakemake?</a></li><li><a href="#a-second-rule-hint">...a second rule hint?</a></li><li><a href="#what-about-the-other-rules">...and what about the other rules?</a></li><li><a href="#keeping-a-fast-iteration-time-during-development">Keeping a fast iteration time during development</a>.</li><li><a href="#my-snakefiles-are-getting-too-big">My snakefiles are getting too big!</a></li><li><a href="#dealing-with-intermediate-files">Dealing with intermediate files</a>.</li><li><a href="#but-I-want-to-run-the-yellow-bits-too">But I want to run the yellow bits too!</a></li><li><a href="#read-groups-what-now">Read groups what now?</a></li><li><a href="#whats-in-the-fastq-header">What&#x27;s in the fastq header?</a></li><li><a href="#getting-variant-calling-rules-working">Getting variant-calling rules working</a></li><li><a href="#i-cant-install-octopus">I can&#x27;t install Octopus!</a></li><li><a href="#octopus-is-taking-too-long">Octopus is taking too long!</a></li><li><a href="#what-ploidy">What ploidy?</a></li><li><a href="#tools-that-use-temporary-directories">Tools that use temporary directories</a></li><li><a href="#tips-on-using-bwa-mem">Tips on using <code>bwa mem</code></a>.</li><li><a href="#tips-on-using-samtools">Tips on using <code>samtools</code></a>.</li><li>Or see a <a href="#solutions">complete solution</a>.</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="getting-started">Getting started<a class="hash-link" href="#getting-started" title="Direct link to heading">​</a></h3><p>You should create: a folder called <code>data</code> with the data in, a folder called <code>results</code> to put
results in, and a folder called <code>pipelines</code> to put snakemake pipelines in. So your folder will look
something like this:</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">this_folder/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  data/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # reads and reference sequence here</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pipelines/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # snakefiles go here</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  results/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # results files go here</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Of course you should already have <code>data</code> and snakemake will create the <code>results</code> folder as you go.
So to get started, all you have to do is write a snakefile in <code>pipelines/</code>.</p><p>Maybe you want to make an empty snakefile to get started?</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">touch pipelines/analysis.snakefile</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And run it:</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">snakemake -s pipelines/analysis.snakefile -n</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Congratulations!  You&#x27;ve started your pipeline.</p><p>To really get started, you will need some <a href="#give-me-a-first-rule-hint">rules in there</a> and will also
need a <strong>config file</strong> as outlined <a href="#how-should-i-put-sample-information-in">below</a> - it can go in
<code>pipelines</code> or in the top-level folder, whichever you prefer.</p><p><a href="#tips-and-tricks">Go back to the list of tips and tricks</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="give-me-a-first-rule-hint">Give me a first rule hint?<a class="hash-link" href="#give-me-a-first-rule-hint" title="Direct link to heading">​</a></h3><p>There are two sensible things you could do at the start of the pipeline.</p><p>First, you could start at the top-left of the <a href="/chg-training-resources/sequence_data_analysis/building_an_ngs_pipeline/pipeline/#the-pipeline">pipeline</a>, and write a
rule that indexes the reference file:</p><div class="language-snakemake codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-snakemake codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">rule index_reference_assembly:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        index = &quot;data/reference/Pf3D7_v3.fa.gz.bwt&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fasta = &quot;data/reference/Pf3D7_v3.fa.gz&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shell: &quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bwa index {input.fasta}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;&quot;&quot;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Top tip</h5></div><div class="admonition-content"><p>Notice that I wrote the <strong>output</strong> files first.  You don&#x27;t have to do this, but it makes huge sense for snakemake, which works
backwards from outputs to figure out what inputs it needs.</p></div></div><p>If you run snakemake now:</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">snakemake -s pipelines/analysis.snakefile --cores 1</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You will probably see it indexing the reference assembly.  Well done!</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>input and wildcards</h5></div><div class="admonition-content"><p>The <code>{input.fasta}</code> is of course one of snakemake&#x27;s cool features.  You don&#x27;t have to write the whole filename out again, just use
this form to refer to the filename from the <code>input:</code> section.</p></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="how-should-i-get-sample-information-in">How should I get sample information in?<a class="hash-link" href="#how-should-i-get-sample-information-in" title="Direct link to heading">​</a></h3><p>Your pipeline is going to need the sample information in.</p><p>Although you can add sample information into the top of the snakefile, say:</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">samples = [ &#x27;QG0033-C&#x27;, &#x27;QG0041-C&#x27;, and so on ]</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>...that&#x27;s not very flexible.  A better way is to put this information about the samples, and any
other needed data in through a <strong>config file</strong>.</p><p>This is a file called (say) <code>config.json</code> that you pass in using the <code>--configfile</code> argument. For
example, for this project you could use a <code>config.json</code> that looks like this:</p><div class="language-json codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-json codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;reference&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;data/reference/Pf3D7_v3.fa.gz&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;fastq_filename_template&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;data/reads/{ID}_{read}.fastq.gz&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;samples&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;QG0033-C&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;accession&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ERR377582&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;QG0041-C&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;accession&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ERR377591&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;QG0049-C&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;accession&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ERR417627&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;QG0056-C&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;accession&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ERR417621&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;QG0088-C&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;accession&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ERR377629&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>(This contains information copied from <code>samples.tsv</code>.) And then you would run snakemake like this:</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">snakemake -s pipelines/analysis.snakefile --configfile config.json</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The point of this is that it makes it easy to run the pipeline on different sets of data - such as
<a href="#keeping-a-fast-iteration-time-during-development">a test data for pipeline testing</a> - you just
swap out the config file for a different one.</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Note</h5></div><div class="admonition-content"><p>In a real pipeline there are likely to be many samples, so it might be better to reference the sample
sheet in the config file:</p><div class="language-json codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-json codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;reference&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;data/reference/Pf3D7_v3.fa.gz&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;fastq_filename_template&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;data/reads/{ID}_{read}.fastq.gz&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;samples&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;samples.tsv&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and then have your snakefile load the samples using (for example)
<a href="/chg-training-resources/prerequisites/pandas.md/">pandas</a>:</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">import pandas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config[&#x27;samples&#x27;] = pandas.read_table( &quot;samples.tsv&quot; )</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div><p><a href="#tips-and-tricks">Go back to the list of tips and tricks</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="how-should-i-run-snakemake">How should I run snakemake?<a class="hash-link" href="#how-should-i-run-snakemake" title="Direct link to heading">​</a></h3><p>Let&#x27;s say your snakefile is <code>pipelines/analysis.snakefile</code>.  I find the best way to run snakemake is to <em>always run it
from the top-level folder.</em>  That is, as above, you would run:</p><div class="language-sh codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-sh codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">snakemake -s pipelines/analysis.snakefile -configfile config.json [other options...]</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Doing this means that in your snakefile you can use relative pathnames. So for example if the input
file is one of the data files, you can write:</p><div class="language-python codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-python codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">rule something</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">input</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;data/reads/{ID}.fastq.gz&quot;</span><span class="token plain">`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;results/qc/{ID}.aligned.bam&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">etc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and so on. This is great because you don&#x27;t need absolute paths; it makes the snakefiles shorter and
it makes it is easy to copy the code around, or to share the pipeline via github, and so on.</p><p><strong>Note.</strong> The snakemake documentation suggests a <a href="https://snakemake.readthedocs.io/en/stable/snakefiles/deployment.html" target="_blank" rel="noopener noreferrer">similar, but slightly different
layout</a>.</p><p><a href="#tips-and-tricks">Go back to the list of tips and tricks</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="a-second-rule-hint">...a second rule hint?<a class="hash-link" href="#a-second-rule-hint" title="Direct link to heading">​</a></h3><p>Well, the second step (top right of <a href="/chg-training-resources/sequence_data_analysis/building_an_ngs_pipeline/pipeline/#the-pipeline">the pipeline</a>) is to run fastqc.  A rule to do that is pretty easy,
right?  Something like:</p><div class="language-python codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-python codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">rule run_fastqc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        html1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;results/qc/{ID}_1_fastqc.html&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        html2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;results/qc/{ID}_2_fastqc.html&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">input</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fq1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;data/reads/{ID}_1.fq.gz&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fq2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;data/reads/{ID}_2.fq.gz&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        outputdir </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;results/qc/&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shell</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        fastqc -q -o {params.outputdir} {input.fq1} {input.fq2}</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You can see this rule contains the <code>{ID}</code> which is a snakemake <strong>wildcard</strong>.  If snakemake thinks it needs to make (for example) the file <code>results/qc/A_1_fastqc.html</code>, it will run this rule with <code>ID=&quot;A&quot;</code>.</p><p>But there are two problems.</p><p><strong>Problem 1</strong>. If you add this and run snakemake, it won&#x27;t do anything!</p><p><strong>Solution</strong>: remember the first rule in the snakefile declares the main files it will try to create.  If you want it to
create these fastqc output files, you had better add them there.  The convention is to add a rule called &#x27;all&#x27; at the
top which lists what you want, something like:</p><div class="language-python codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-python codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">rule </span><span class="token builtin">all</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">input</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fastqc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> expand</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;results/qc/{ID}_{read_id}_fastqc.html&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;samples&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">keys</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            read_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;1&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Note</h5></div><div class="admonition-content"><p>The <code>expand()</code> function is used there to replace all the <code>ID</code> and <code>read_id</code> with all the combinations of the arguments.</p></div></div><p>But there&#x27;s another, harder problem too!  (This one is actually the trickiest problem in the whole pipeline.)</p><p><strong>Problem 2</strong>.<br>
<!-- -->The <a href="/chg-training-resources/sequence_data_analysis/building_an_ngs_pipeline/pipeline/#overview">requirements</a> say that we are supposed to name the output files by the sample ID (like &quot;QG0033-C&quot;).
But the fastq files are named a different way (for these files, it&#x27;s for the accessions, like &quot;ERR377582&quot;.)
So this means is that <strong>the above rule won&#x27;t fully solve the problem</strong>. </p><p><strong>Solution</strong> For fastqc, this is slightly annoying to solve because it <a href="https://github.com/s-andrews/FastQC/issues/9" target="_blank" rel="noopener noreferrer">doesn&#x27;t have a way to rename output
files</a>.  The easiest way to solve this is first create a re-named copy of
the input files.  Let&#x27;s do that now - what we need is a rule like this:</p><div class="language-python codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-python codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">rule make_renamed_fastqs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fq1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;results/renamed_reads/{ID}_1.fastq.gz&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fq2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;results/renamed_reads/{ID}_2.fastq.gz&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">input</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fq1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;data/reads/{accession}_1.fq.gz&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fq2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;data/reads/{accession}_2.fq.gz&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shell</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    cp {input.fq1} {output.fq1}</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    cp {input.fq2} {output.fq2}</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>But how do you get snakemake to compute the accessions in there?</p><p>The trick here is remember the golden rule: snakemake works <strong>from outputs to inputs</strong>.  What you need is a function
that converts the desired output sample ID (e.g. <code>QG0033-C</code>) into the correct input filename (e.g.
<code>data/reads/ERR377582_1.fastq.gz</code>).  Luckily, if you followed the <a href="#how-should-i-get-sample-information-in">suggestion above</a>
you&#x27;ll have put this information into the config file - so you could get it out using a function like this:</p><div class="language-python codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-python codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_accession</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> sample </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;samples&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">sample</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;accession&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To plumb this into snakemake, write functions that read in the rule&#x27;s wildcards and outputs the fastq filename:</p><div class="language-python codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-python codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_fq1_filename</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> wildcards </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;data/reads/{accession}_1.fastq.gz&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        accession </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> get_accession</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> wildcards</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ID </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_fq2_filename</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> wildcards </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;data/reads/{accession}_2.fastq.gz&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        accession </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> get_accession</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> wildcards</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ID </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>...at which point you can use the function in place of the input filename in the rule:</p><div class="language-python codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-python codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">rule make_renamed_fastqs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fq1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;results/renamed_reads/{ID}_1.fastq.gz&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fq2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;results/renamed_reads/{ID}_2.fastq.gz&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">input</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fq1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> get_fq1_filename</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fq2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> get_fq2_filename</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shell</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    cp {input.fq1} {output.fq1}</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    cp {input.fq2} {output.fq2}</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>Tip</h5></div><div class="admonition-content"><p>Since the data is large and there might be lots of samples, it&#x27;s actually better to use <strong>symbolic links</strong> here instead of copies.
(A synbolic link is a bit like a shortcut - a small file that points at the other, larger file.)</p><p>To use symbolic links instead of copies, use <code>ln -s</code> instead of <code>cp</code> in the above commands, like this:</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">ln -s ../../{input.fq1} {output.fq1}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>(The <code>../..</code> is needed to get the right path of the linked file relative to the folder where the output is.)</p></div></div><p><strong>Finally</strong> update the <code>run_fastqc</code> rule to use these files instead:</p><div class="language-python codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-python codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">rule run_fastqc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        html1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;results/qc/{ID}_1_fastqc.html&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        html2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;results/qc/{ID}_2_fastqc.html&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">input</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fq1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;results/renamed_reads/{ID}_1.fastq.gz&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fq2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;results/renamed_reads/{ID}_2.fastq.gz&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    etc</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Phew!</strong></p><p>If all this seemed like a lot of work - it was.</p><p>(But note it has made the rest of the pipeline easier because you can use the re-named fastq files as input to other
rules, too - such as the step that aligns reads.)</p><p><a href="#tips-and-tricks">Go back to the list of tips and tricks</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="what-about-the-other-rules">...what about the other rules?<a class="hash-link" href="#what-about-the-other-rules" title="Direct link to heading">​</a></h3><p>You have to write these yourself!</p><p>However you should</p><ul><li><p>Look at the <a href="/chg-training-resources/sequence_data_analysis/building_an_ngs_pipeline/pipeline/#the-pipeline">pipeline steps</a> to see what steps are needed...</p></li><li><p>...and look at the <a href="/chg-training-resources/sequence_data_analysis/introduction_to_next_generation_sequencing_data_analysis/Aligning_reads/">sequence data pipeline tutorial</a> to see what the needed
commands are.</p></li><li><p>And perhaps look back at the <a href="#give-me-a-first-rule-hint">first rule hint</a> and the <a href="#a-second-rule-hint">second rule hint</a> to figure out how to write them.</p></li><li><p>To make life easier you might want to use the renamed input fastq files <a href="#a-second-rule-hint">described above</a> as
inputs. That way you should just be able to use &#x27;{ID}&#x27; as the wildcard throughout the pipeline, i.e. like this:</p></li></ul><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">output: &quot;results/somewhere/output_file_{ID}.txt&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input: &quot;somewhere_else/input_file_{ID}.txt&quot;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and snakemake will figure out the correct input file from the output file.</p><p>Good luck!</p><p><a href="#tips-and-tricks">Go back to the list of tips and tricks</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="keeping-a-fast-iteration-time-during-development">Keeping a fast iteration time during development.<a class="hash-link" href="#keeping-a-fast-iteration-time-during-development" title="Direct link to heading">​</a></h3><p>The data from this pipeline are pretty large, and it will take a while for the pipeline to run.
That&#x27;s no good for pipeline development as you&#x27;ll want to know pretty quickly whether it works or doesn&#x27;t work.
(After all you don&#x27;t want to wait two hours only to discover that it failed.)</p><p>A good idea would therefore be to start by creating smaller, sub-sampled version of the
datasets (whichever of the above raw data you use). For example, you could run:</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">gunzip -c filename.fastq.gz | head -n 4000 | gzip -c &gt; filename.subsampled.fastq</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>to take the first few reads from each file.</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Question</h5></div><div class="admonition-content"><p>The above command specifies a multiple of 4 lines. Why? How many reads does the above
command extract?</p></div></div><p>If you set your config files the way I <a href="#how-should-i-get-sample-information-in">suggested above</a> then you can have one
config file for the smaller test dataset (giving them new IDs, such as <code>QG0033-c-subsampled</code>, to avoid conflicts). Then,
once it is all working, you can rerun using the real config file specifying the full dataset.</p><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>Note</h5></div><div class="admonition-content"><p>Of course, for this to work you&#x27;ll have to <strong>make sure your rules find the fastq files using the paths from the config
file</strong> rather than hard-coding them. I called that <code>fastq_filename_template</code> in the <a href="#how-should-i-get-sample-information-in">suggested config
file</a>.</p></div></div><p><a href="#Tips-and-tricks">Go back to the list of tips and tricks</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="my-snakefiles-are-getting-too-big">My snakefiles are getting too big!<a class="hash-link" href="#my-snakefiles-are-getting-too-big" title="Direct link to heading">​</a></h3><p>After a while you&#x27;ll find your pipelines have loads of rules and can become hard to understand.</p><p>To fix this, I often use the snakemake
<a href="https://snakemake.readthedocs.io/en/stable/snakefiles/modularization.html" target="_blank" rel="noopener noreferrer"><code>include</code> feature</a> to split up the
file into components of related rules. For example, in our pipeline there are a bunch of rules for
read qc, some for alignment and post-processing, a bunch for variant calling, and a bunch for
computing coverage and so on. So for the whole pipeline above I might end up with this structure:</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">analysis folder/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pipelines/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        master.snakmake</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        functions.snakemake</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        qc.snakemake</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        alignment.snakemake</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        variants.snakemake</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        coverage.snakemake</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And the first few lines of <code>master.snakemake</code> would be:</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">include: &quot;functions.snakemake&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include: &quot;qc.snakemake&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include: &quot;alignment.snakemake&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include: &quot;variants.snakemake&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include: &quot;coverage.snakemake&quot;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now you can write one &#x27;module&#x27; of the pipeline in each file, keeping related rules together without
them becoming too big and unweildy.</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Note</h5></div><div class="admonition-content"><p>You&#x27;ll notice I included a <code>functions.snakemake</code> above. This is where I tend to put helper
functions, like the <code>get_fq1_filename()</code> function mentioned above.</p></div></div><p><a href="#Tips-and-tricks">Go back to the list of tips and tricks</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="dealing-with-intermediate-files">Dealing with intermediate files<a class="hash-link" href="#dealing-with-intermediate-files" title="Direct link to heading">​</a></h3><p>The alignment steps in <a target="_blank" href="/chg-training-resources/assets/files/pipeline-f7b1538da80891cc35465d36fdd41f64.svg/">our pipeline</a> in particular are notorious for generating intermediate files.  Indeed:</p><ul><li>the alignment step outputs a SAM file...</li><li>which is converted to a BAM file...</li><li>which you then have to sort by position...</li><li>in which you then have to mark the duplicates...</li><li>which are then indexed.</li></ul><p>That&#x27;s at least 3 intermediate files along the way. We don&#x27;t want to keep these, they were just needed during the pipeline.</p><p>There are a few different ways to deal with this. One way is just to use unix pipes to pipe command together within rules - as in</p><div class="language-sh codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-sh codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">bwa mem reference.fa read1.fq read2.fq | samtools view -b -o aligned.bam</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>However, I find that this makes the pipeline hard to debug (which command failed? you can&#x27;t tell.)</p><p>Instead, I typically go for temp files and use the snakemake <code>temp()</code> function to tell snakemake files are temporary. So I might write the alignment rule as:</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">rule align_reads:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  output:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sam = temp( &quot;results/alignment/{ID}.sam&quot; )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  input:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fq1 = something,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fq2 = something</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  shell: &quot;bwa mem ...&quot;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As you can see, I tend to also put temporary files into their own <code>tmp/</code> folder as well - this
avoids cluttering up the results folder when jobs fail.</p><p>Second, rules can refer to other rule outputs, so the next step in the pipeline can be written:</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">rule fix_matepair_information_and_convert_to_bam:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  output:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bam = temp( &quot;results/alignment/tmp/{ID}.bam&quot; )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  input:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sam = rules.align_reads.output.sam</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  shell: &quot;samtools fixmate -m {input.sam} {output.bam}&quot;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and so on down the pipeline.</p><p>Third - <code>snakemake</code> actually has a <a href="https://snakemake.readthedocs.io/en/stable/snakefiles/rules.html#piped-output" target="_blank" rel="noopener noreferrer">named pipe
output</a> feature, so you can get the
benefit of the UNIX pipe with the same syntax as above - just replace <code>temp()</code> with <code>pipe()</code> and it should automatically
work. (I&#x27;ve never actually used this feature but it&#x27;s a nice idea for this step, because the SAM file output by <code>bwa</code>
might be huge when applied to real data.)</p><p><a href="#Tips-and-tricks">Go back to the list of tips and tricks</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="but-i-want-to-run-the-yellow-bits-too">But I want to run the yellow bits too!<a class="hash-link" href="#but-i-want-to-run-the-yellow-bits-too" title="Direct link to heading">​</a></h3><p>Be my guest! Running variant annotation in particular would be a good thing to do, as would looking
at post-alignment QC metrics.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="read-groups-what-now">Read groups what now?<a class="hash-link" href="#read-groups-what-now" title="Direct link to heading">​</a></h3><p>Some programs require reads to have &#x27;read groups&#x27;. What are they and how do you get them in there?</p><p>BAM files can easily be post-processed and merged. Read groups are a way to put information in that
records the original sample and the sequencing run, so that downstream programs can distinguish
these. The read groups are encoded in the <code>@RG</code> header field of the BAM file (which you can see
using <code>samtools view -h</code>), and in the <code>RG</code> tag for each alignment. A good document on read groups
is <a href="https://gatk.broadinstitute.org/hc/en-us/articles/360035890671-Read-groups" target="_blank" rel="noopener noreferrer">this one on the GATK
website</a>.</p><p>In our pipeline these don&#x27;t seem that important (we have one alignment file per input fastq file
pair), but in other pipelines the same sample might have been sequenced many times and the results
merged. So for sensible downstream analysis it would be important to keep track of the originating
samples. In particular, variant callers like <code>octopus</code> require you to have read groups in the BAM
file.</p><p>The simplest way to put read groups into the BAM file is to have <code>bwa</code> put them in at the alignment
step. For our experiment this can be done using the <code>-R</code> option - e.g. for sample <code>QC0033-C</code> this
would look like this:</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">bwa mem -R &quot;@RG\tID:ERR377582\tSM:QG0033-C\tPL:ILLUMINA&quot; [other arguments]</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You can put other stuff into a read group (see below), but the run ID, the sample name, and the
platform are all that we need just now.</p><p>Of course you have to be able to generate this for each sample. With the layout described above, I
wrote the following code (which I put, of course, in <code>pipelines/functions.snakemake</code>) to do it:</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">def get_read_group_line( name ):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sample = find_sample_with_name( name )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return &quot;@RG\\tID:{ID}\\tSM:{sample}\\tPL:ILLUMINA&quot;.format(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ID = sample[&#x27;ID&#x27;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sample = sample[&#x27;name&#x27;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The alignment step could then be updated to use this function:</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">rule align_reads:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  input:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fq1 = something,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fq2 = something</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  output:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sam = temp( &quot;results/alignment/{ID}.sam&quot; )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  params:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    read_group_spec = lambda wildcards: get_read_group_line( wildcards.name )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  shell: &quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bwa mem -R {params.read_group_spec} ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;&quot;&quot;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If you look at the resulting files, they have an <code>@RG</code> header record and <code>RG</code> tags for each read -
octopus will then accept these files.</p><p>What else can go in a read group? As the <a href="https://gatk.broadinstitute.org/hc/en-us/articles/360035890671-Read-groups" target="_blank" rel="noopener noreferrer">GATK documentation
indicates</a> the read
group can also contain information about the sequencing flowcell, lane, and sample barcode, and an
identifier for the library itself. Unfortunately some of this information can be hard to come by
depending on where your reads come from. As we describe below, some of it can be obtained from the
read names in the fastq files. For the data in this practical, some parts such as the library
identifier can be found on the <a href="/chg-training-resources/sequence_data_analysis/building_an_ngs_pipeline/tips_and_tricks/ERR377582/">ENA website</a>. But in general it&#x27;s a bit hard to put it
all together. (Luckily just the sample name and identifier are enough for our analysis.)</p><p><a href="#Tips-and-tricks">Go back to the list of tips and tricks</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="whats-in-the-fastq-header">What&#x27;s in the fastq header?<a class="hash-link" href="#whats-in-the-fastq-header" title="Direct link to heading">​</a></h3><p>If you look at the header / read name rows of a fastq file you&#x27;ll see they actually contain a bunch
of information - like this:</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">@ERR377582.7615542 HS23_10792:2:2307:6524:31920#15/1</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This row tells us the sample ID (<code>ERR377582</code>) and the read identifier (<code>7615542</code>). And this is
followed by information identifying the instrument that generated the reads (<code>HS23_10792</code>), the
flowcell lane and tile number in the lane (<code>2:2307</code>), the coordinates of the
<a href="https://www.broadinstitute.org/files/shared/illuminavids/clusterGenSlides.pdf" target="_blank" rel="noopener noreferrer">cluster</a> within the
tile (<code>6524</code>, <code>31920</code>), a number identifying the index of the sample within a multiplexed set of
samples (i.e. all run at the same time; <code>#15</code>), and whether it&#x27;s read 1 or 2.</p><p>Some of this info can be put in the read group as well.</p><p><strong>Note.</strong> The format of this information is not standard across platforms, and it changes depending
on your data provider. Some other examples can be found <a href="https://en.wikipedia.org/wiki/FASTQ_format#Illumina_sequence_identifiers" target="_blank" rel="noopener noreferrer">on
wikipedia</a> or on the
<a href="https://gatk.broadinstitute.org/hc/en-us/articles/360035890671-Read-groups" target="_blank" rel="noopener noreferrer">GATK read groups page</a>.</p><p><a href="#Tips-and-tricks">Go back to the list of tips and tricks</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="getting-variant-calling-rules-working">Getting variant-calling rules working<a class="hash-link" href="#getting-variant-calling-rules-working" title="Direct link to heading">​</a></h3><p>The variant calling rule will be slightly different because it will call across all samples at once.
So it has multiple input files, and only one output file.</p><p>This turns out to be easy in snakemake.  Instead of making a single filename input:</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">rule my_rule:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output: &quot;results/variants.vcf.gz&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input: &quot;results/alignment/{ID}.bam&quot;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>...you make the input a list of files:</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">rule my_rule:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vcf = &quot;results/variants.vcf.gz&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bams = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;results/alignment/Sample_1.bam&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;results/alignment/Sample_2.bam&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            etc.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shell: &quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        octopus -i {input.alignments} (other arguments...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;&quot;&quot;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Note</h5></div><div class="admonition-content"><p>In the shell command, the multiple files are just pasted next to each other, so the command ends up looking like:</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">octopus -i &quot;results/alignment/Sample_1.bam&quot; &quot;results/alignment/Sample_2.bam&quot; (other arguments...)</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div><p>That works just fine... but is a bit annoying as you&#x27;d have to hard-code all those sample IDs again.</p><p>Luckily snakemake provides a short-hand for this, in the form of the <code>expand()</code> function:</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">rule my_rule:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vcf = &quot;results/variants.vcf.gz&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bams = expand(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;results/alignment/{ID}.bam&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            config[&#x27;samples&#x27;].keys()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (etc.)</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>So now your rule will take multiple outputs and produce one input.</p><p><a href="#Tips-and-tricks">Go back to the list of tips and tricks</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="i-cant-install-octopus">I can&#x27;t install Octopus!<a class="hash-link" href="#i-cant-install-octopus" title="Direct link to heading">​</a></h3><p>On my system I have the problem that conda won&#x27;t install Octopus for me.
(This is because there&#x27;s no <a href="https://anaconda.org/bioconda/octopus" target="_blank" rel="noopener noreferrer">conda package available on bioconda for my mac</a>.)</p><p>If you run into this, you have three options:</p><ol><li>Give up and don&#x27;t bother with variant calls.  (Have you really had enough of this pipelining challenge?)</li><li>Install octopus yourself <a href="https://github.com/luntergroup/octopus" target="_blank" rel="noopener noreferrer">from github</a>.  See the &#x27;Quick start&#x27; instructions there.</li><li>Or switch to another variant caller.</li></ol><p>The simplest variant caller you could use is actually <code>bcftools</code> (which conda probably will install for you.)  </p><p>There&#x27;s a worked example of using <code>bcftools</code> on <a href="/chg-training-resources/sequence_data_analysis/variant_calling_and_imputation/Variant_calling/">this page</a>, but
here&#x27;s a quick guide.  </p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Calling with bcftools </h5></div><div class="admonition-content"><p>Calling variants using bcftools takes two steps:</p><ol><li>Run <code>bcftools mpileup</code> to summarise the data in the reads at each position - something like:</li></ol><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">bcftools mpileup \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--output-type z \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-f [reference fasta filename] \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-o results/variants/mpileup.vcf.gz \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sample1.bam sample2.bam ...</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>--output-type z</code> part of the above command tells <code>bcftools</code> to output a <a href="https://samtools.github.io/hts-specs/VCFv4.2.pdf" target="_blank" rel="noopener noreferrer"><strong>(b)gzipped VCF
file</strong></a>, which is a standard way of encoding genetic variation data.</p><p>(The backslash characters here (<code>\</code>) are &#x27;line continuation&#x27; characters - they just tell bash to treat the above as one command.)</p><ol start="2"><li>The output file of the <code>mpileup</code> step has information for all samples at every site in the reference genome (so
something like 23 million rows).  What we want is just to find the sites where there&#x27;s genetic variation and compute
their genotypes - that&#x27;s what <code>bcftools call</code> does.  Run it something like this:</li></ol><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">bcftools call \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--output-type z \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--multiallelic-caller \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--variants-only \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> -o results/variants/calls.vcf.gz \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">results/variants/mpileup.vcf.gz</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If you look at the output file, you should see it has rows for only a subset of positions in the genome - the sites
where <code>bcftools</code> thinks there are genetic variants.</p></div></div><p>If you don&#x27;t fancy <code>bcftools</code> or <code>octopus</code>, the <a href="/chg-training-resources/sequence_data_analysis/building_an_ngs_pipeline/pipeline/#the-pipeline">pipeline</a> also has a list of other variant
callers you could attempt. They will all give similar, but slightly different output (it&#x27;d be interesting to compare...)</p><p><a href="#Tips-and-tricks">Go back to the list of tips and tricks</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="octopus-is-taking-too-long">Octopus is taking too long!<a class="hash-link" href="#octopus-is-taking-too-long" title="Direct link to heading">​</a></h3><p>The <a href="https://github.com/luntergroup/octopus" target="_blank" rel="noopener noreferrer">Octopus variant caller</a> can take a long time to do its
work - hopefully reflecting that it is trying its best to make high-quality variant calls. This
might take too long to run on your laptop. If so, here are some options for speeding it up:</p><ul><li><p>If you have a multi-core CPU, you can use more threads (<code>--threads</code> argument).</p></li><li><p>Restrict to a set of regions. You can add the <code>--regions</code> option to tell Octopus to only work on specified regions. For this
tutorial, please include these regions: <code>--regions Pf3D7_02_v3:616190-656190 Pf3D7_02_v3:779288-859288
Pf3D7_11_v3:1023035-1081305</code>. (This brought the calling down to about half and hour when I tried it.)</p></li><li><p>You could also try the Octopus &#x27;fast&#x27; or &#x27;very fast&#x27; modes - though I haven&#x27;t tried this.</p></li></ul><p>See <code>octopus --help</code> for a full list of options.</p><p>(In general this might be less of a problem for real work as you might run it a compute cluster.)</p><p>Another option is to try a different variant caller - <a href="https://gatk.broadinstitute.org/hc/en-us" target="_blank" rel="noopener noreferrer"><code>GATK HaplotypeCaller</code></a>,
<a href="https://www.nature.com/articles/nbt.4235" target="_blank" rel="noopener noreferrer"><code>DeepVariant</code></a> or <a href="https://github.com/freebayes/freebayes" target="_blank" rel="noopener noreferrer"><code>freebayes</code></a> might be
possibilities. For a simple approach you could also use <a href="https://samtools.github.io/bcftools/bcftools.html" target="_blank" rel="noopener noreferrer"><code>bcftools mpileup</code> and <code>bcftools
call</code></a> (this is likely to be substantially faster as it relies on the input
alignments does not try to reconstruct local haplotypes near each variant.). </p><p><a href="#Tips-and-tricks">Go back to the list of tips and tricks</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="what-ploidy">What ploidy?<a class="hash-link" href="#what-ploidy" title="Direct link to heading">​</a></h3><p>Blood-stage malaria parasites are <a href="https://www.cdc.gov/malaria/about/biology/index.html" target="_blank" rel="noopener noreferrer">haploid</a>.
So set octopus <code>--organism-ploidy 1</code>.</p><p>On the other hand, <a href="https://doi.org/10.7554/eLife.40845.001" target="_blank" rel="noopener noreferrer">mixed infections are common</a>, and to
handle this most projects actually treat samples as if they were diploid - they then treat
heterozygote calls as &#x27;mixed&#x27; calls. This is <em>ad hoc</em> but works ok. So you could set
<code>--organism-ploidy 2</code>.</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Note</h5></div><div class="admonition-content"><p><code>bcftools call</code> has a similar option, called <code>--ploidy</code>.</p></div></div><p>For the purposes of this tutorial you could do either - or both so we can see the difference?</p><p><a href="#Tips-and-tricks">Go back to the list of tips and tricks</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="tools-that-use-temporary-directories">Tools that use temporary directories<a class="hash-link" href="#tools-that-use-temporary-directories" title="Direct link to heading">​</a></h3><p>Some tools have that bad habit of leaving &#x27;stuff&#x27; in the directory you run them in. This is really
annoying for pipelines because you don&#x27;t want that - you want to put the temp stuff away somewhere
out of the way. <code>octopus</code> is one of these tools: if you run it you&#x27;ll see it outputs a directory
called <code>octopus-temp</code>.</p><p>Really the only way to deal with this is use the program help to find the option that renames the
temp dir - then send it somewhere different. For example:</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">octopus [other options] --temp-directory-prefix results/variants/tmp/octopus/</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This will probably work here. (In general you may need to use snakemake wildcards etc. to name this
temp directory so it doesn&#x27;t clash if the same rule runs multiple jobs in parallel.)s</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="tips-on-using-bwa-mem">Tips on using <code>bwa mem</code><a class="hash-link" href="#tips-on-using-bwa-mem" title="Direct link to heading">​</a></h3><p>Here are a few options you can use to <code>bwa mem</code> which you might want to consider using.</p><ul><li><p>Run <code>bwa mem</code> for a list of options.</p></li><li><p>The basic usage is <code>bwa mem -o output.sam [path to indexed fasta file] read1.fq.gz read2.fq.gz</code></p></li><li><p>The <code>-t</code> option tells <code>bwa</code> to use more than one thread.  (If doing this, make sure to also <a href="https://snakemake.readthedocs.io/en/stable/snakefiles/rules.html#threads" target="_blank" rel="noopener noreferrer">tell snakemake the number of threads it will use</a>.)</p></li><li><p>The <code>-R</code> option specifies that <code>bwa</code> should include a read group header line and read groups tags in the output - this is <a href="#read-groups-what-now">described above</a>.</p></li><li><p>By default, <code>bwa</code> will output only the best alignment for each read.  However, if you specify the <code>-a</code> option then <code>bwa</code> will output multiple possible alignments for each read, but all except one will be marked as &#x27;not a primary alignment&#x27; (using the <a href="https://broadinstitute.github.io/picard/explain-flags.html" target="_blank" rel="noopener noreferrer"><code>SAM flags</code></a>).  This can be useful in cases when you want to consider possible alternate alignments.</p></li></ul><p>There are also other aligners out there. <a href="https://github.com/lh3/minimap2" target="_blank" rel="noopener noreferrer"><code>minimap2</code></a> is another
good choice. Nevertheless the field typically currently uses <code>bwa mem</code> for Illumina short-read NGS
data.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="tips-on-using-samtools">Tips on using <code>samtools</code><a class="hash-link" href="#tips-on-using-samtools" title="Direct link to heading">​</a></h3><p>Here are some tips on using <code>samtools</code>:</p><ul><li><p>Run <code>samtools</code> for a list of commands, and <code>samtools [command]</code> for a list of options for each command.</p></li><li><p>Some commands, like <code>samtools markdup</code>, take the output filename as a seperate argument.  But others, such as <code>samtools view</code> or <code>samtools sort</code>, want you to use the <code>-o</code> option to specify the output file (otherwise they output to standard output).</p></li><li><p><code>multiqc</code> can read <code>samtools stats</code> output, useful for post-alignment QC.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="solutions">Solutions<a class="hash-link" href="#solutions" title="Direct link to heading">​</a></h3><p>A complete solution to this tutorial can be found
<a href="https://github.com/chg-training/chg-training-resources/tree/main/docs/sequence_data_analysis/building_an_ngs_pipeline/solutions" target="_blank" rel="noopener noreferrer">in this folder</a>.</p><p>Warning: this is a full solution!</p><p>(As mentioned above, I used a rename-files-at-the end strategy so this might look a bit different to yours.)</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="good-luck">Good luck!<a class="hash-link" href="#good-luck" title="Direct link to heading">​</a></h2></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/chg-training/chg-training-resources/edit/main/docs/sequence_data_analysis/building_an_ngs_pipeline/tips_and_tricks.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/chg-training-resources/sequence_data_analysis/building_an_ngs_pipeline/pipeline/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">The pipeline</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/chg-training-resources/sequence_data_analysis/variant_calling_and_imputation/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Variant calling, phasing and imputation</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#getting-started" class="table-of-contents__link toc-highlight">Getting started</a></li><li><a href="#give-me-a-first-rule-hint" class="table-of-contents__link toc-highlight">Give me a first rule hint?</a></li><li><a href="#how-should-i-get-sample-information-in" class="table-of-contents__link toc-highlight">How should I get sample information in?</a></li><li><a href="#how-should-i-run-snakemake" class="table-of-contents__link toc-highlight">How should I run snakemake?</a></li><li><a href="#a-second-rule-hint" class="table-of-contents__link toc-highlight">...a second rule hint?</a></li><li><a href="#what-about-the-other-rules" class="table-of-contents__link toc-highlight">...what about the other rules?</a></li><li><a href="#keeping-a-fast-iteration-time-during-development" class="table-of-contents__link toc-highlight">Keeping a fast iteration time during development.</a></li><li><a href="#my-snakefiles-are-getting-too-big" class="table-of-contents__link toc-highlight">My snakefiles are getting too big!</a></li><li><a href="#dealing-with-intermediate-files" class="table-of-contents__link toc-highlight">Dealing with intermediate files</a></li><li><a href="#but-i-want-to-run-the-yellow-bits-too" class="table-of-contents__link toc-highlight">But I want to run the yellow bits too!</a></li><li><a href="#read-groups-what-now" class="table-of-contents__link toc-highlight">Read groups what now?</a></li><li><a href="#whats-in-the-fastq-header" class="table-of-contents__link toc-highlight">What&#39;s in the fastq header?</a></li><li><a href="#getting-variant-calling-rules-working" class="table-of-contents__link toc-highlight">Getting variant-calling rules working</a></li><li><a href="#i-cant-install-octopus" class="table-of-contents__link toc-highlight">I can&#39;t install Octopus!</a></li><li><a href="#octopus-is-taking-too-long" class="table-of-contents__link toc-highlight">Octopus is taking too long!</a></li><li><a href="#what-ploidy" class="table-of-contents__link toc-highlight">What ploidy?</a></li><li><a href="#tools-that-use-temporary-directories" class="table-of-contents__link toc-highlight">Tools that use temporary directories</a></li><li><a href="#tips-on-using-bwa-mem" class="table-of-contents__link toc-highlight">Tips on using <code>bwa mem</code></a></li><li><a href="#tips-on-using-samtools" class="table-of-contents__link toc-highlight">Tips on using <code>samtools</code></a></li><li><a href="#solutions" class="table-of-contents__link toc-highlight">Solutions</a></li><li><a href="#good-luck" class="table-of-contents__link toc-highlight">Good luck!</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">License</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/chg-training-resources/LICENSE/">License</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/chg-training/chg-training-resources" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 University of Oxford.  Built with Docusaurus.</div></div></div></footer></div>
<script src="/chg-training-resources/assets/js/runtime~main.2a3d8fab.js"></script>
<script src="/chg-training-resources/assets/js/main.e5fe2fc6.js"></script>
</body>
</html>