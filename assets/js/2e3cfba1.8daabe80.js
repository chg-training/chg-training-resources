"use strict";(self.webpackChunkchg_training_resources=self.webpackChunkchg_training_resources||[]).push([[881],{3905:(e,a,t)=>{t.d(a,{Zo:()=>p,kt:()=>h});var n=t(67294);function r(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}function o(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,n)}return t}function i(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?o(Object(t),!0).forEach((function(a){r(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}function s(e,a){if(null==e)return{};var t,n,r=function(e,a){if(null==e)return{};var t,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)t=o[n],a.indexOf(t)>=0||(r[t]=e[t]);return r}(e,a);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)t=o[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var m=n.createContext({}),l=function(e){var a=n.useContext(m),t=a;return e&&(t="function"==typeof e?e(a):i(i({},a),e)),t},p=function(e){var a=l(e.components);return n.createElement(m.Provider,{value:a},e.children)},c="mdxType",u={inlineCode:"code",wrapper:function(e){var a=e.children;return n.createElement(n.Fragment,{},a)}},d=n.forwardRef((function(e,a){var t=e.components,r=e.mdxType,o=e.originalType,m=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),c=l(t),d=r,h=c["".concat(m,".").concat(d)]||c[d]||u[d]||o;return t?n.createElement(h,i(i({ref:a},p),{},{components:t})):n.createElement(h,i({ref:a},p))}));function h(e,a){var t=arguments,r=a&&a.mdxType;if("string"==typeof e||r){var o=t.length,i=new Array(o);i[0]=d;var s={};for(var m in a)hasOwnProperty.call(a,m)&&(s[m]=a[m]);s.originalType=e,s[c]="string"==typeof e?e:r,i[1]=s;for(var l=2;l<o;l++)i[l]=t[l];return n.createElement.apply(null,i)}return n.createElement.apply(null,t)}d.displayName="MDXCreateElement"},74740:(e,a,t)=>{t.r(a),t.d(a,{assets:()=>m,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>l});var n=t(87462),r=(t(67294),t(3905));const o={sidebar_position:2},i="Maximum likelihood copy number inference",s={unversionedId:"statistical_modelling/Hidden_markov_models/modelling_copy_number_variation",id:"statistical_modelling/Hidden_markov_models/modelling_copy_number_variation",title:"Maximum likelihood copy number inference",description:"Remember that the 'likelihood function' should compute the \"probability of the data given the parameters of interest\".",source:"@site/docs/statistical_modelling/Hidden_markov_models/modelling_copy_number_variation.md",sourceDirName:"statistical_modelling/Hidden_markov_models",slug:"/statistical_modelling/Hidden_markov_models/modelling_copy_number_variation",permalink:"/chg-training-resources/statistical_modelling/Hidden_markov_models/modelling_copy_number_variation",draft:!1,editUrl:"https://github.com/chg-training/chg-training-resources/edit/main/docs/statistical_modelling/Hidden_markov_models/modelling_copy_number_variation.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"sidebar6",previous:{title:"Warmup: examining read coverage in a region",permalink:"/chg-training-resources/statistical_modelling/Hidden_markov_models/glycophorin_cnv_warmup"},next:{title:"Bayesian copy number inference",permalink:"/chg-training-resources/statistical_modelling/Hidden_markov_models/modelling_copy_number_variation_bayes"}},m={},l=[{value:"Copy number inference using MLEs",id:"copy-number-inference-using-mles",level:2}],p={toc:l},c="wrapper";function u(e){let{components:a,...t}=e;return(0,r.kt)(c,(0,n.Z)({},p,t,{components:a,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"maximum-likelihood-copy-number-inference"},"Maximum likelihood copy number inference"),(0,r.kt)("p",null,"Remember that the 'likelihood function' should compute the \"probability of the data given the parameters of interest\".\nIn our case, the 'parameters' are the ",(0,r.kt)("strong",{parentName:"p"},"unobserved copy number")," and the data is - you guessed it - the read coverage!\nLet's use our ",(0,r.kt)("a",{parentName:"p",href:"/chg-training-resources/statistical_modelling/Hidden_markov_models/glycophorin_cnv_warmup"},"empirical modelling")," to set up a likelhood now."),(0,r.kt)("p",null,"Our general model of the effect of CNVs on coverage is that coverage of a site with copy number ",(0,r.kt)("inlineCode",{parentName:"p"},"c")," should be ",(0,r.kt)("inlineCode",{parentName:"p"},"c")," times\nas large as at a site with copy number 1 - plus noise.  (Humans are diploid so the copy number at most sites is 2)."),(0,r.kt)("p",null,"If we think of sequence reads as being generated from each copy independently, a bit of thought shows that the same\nrelationship happens for the variance as well. So following our normal distribution, our model for copy number c would be that"),(0,r.kt)("div",{className:"math math-display"},(0,r.kt)("span",{parentName:"div",className:"katex-display"},(0,r.kt)("span",{parentName:"span",className:"katex"},(0,r.kt)("span",{parentName:"span",className:"katex-mathml"},(0,r.kt)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"},(0,r.kt)("semantics",{parentName:"math"},(0,r.kt)("mrow",{parentName:"semantics"},(0,r.kt)("mtext",{parentName:"mrow"},"coverage"),(0,r.kt)("mo",{parentName:"mrow"},"\u223c"),(0,r.kt)("mi",{parentName:"mrow",mathvariant:"script"},"N"),(0,r.kt)("mrow",{parentName:"mrow"},(0,r.kt)("mo",{parentName:"mrow",fence:"true"},"("),(0,r.kt)("mi",{parentName:"mrow"},"c"),(0,r.kt)("mo",{parentName:"mrow"},"\xd7"),(0,r.kt)("mtext",{parentName:"mrow"},"mean"),(0,r.kt)("mo",{parentName:"mrow",separator:"true"},","),(0,r.kt)("mi",{parentName:"mrow"},"c"),(0,r.kt)("mo",{parentName:"mrow"},"\xd7"),(0,r.kt)("mtext",{parentName:"mrow"},"variance"),(0,r.kt)("mo",{parentName:"mrow",fence:"true"},")"))),(0,r.kt)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"\\text{coverage} \\sim \\mathcal{N}\\left( c \\times \\text{mean}, c \\times \\text{variance} \\right)")))),(0,r.kt)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,r.kt)("span",{parentName:"span",className:"base"},(0,r.kt)("span",{parentName:"span",className:"strut",style:{height:"0.625em",verticalAlign:"-0.1944em"}}),(0,r.kt)("span",{parentName:"span",className:"mord text"},(0,r.kt)("span",{parentName:"span",className:"mord"},"coverage")),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2778em"}}),(0,r.kt)("span",{parentName:"span",className:"mrel"},"\u223c"),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2778em"}})),(0,r.kt)("span",{parentName:"span",className:"base"},(0,r.kt)("span",{parentName:"span",className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),(0,r.kt)("span",{parentName:"span",className:"mord mathcal",style:{marginRight:"0.14736em"}},"N"),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.1667em"}}),(0,r.kt)("span",{parentName:"span",className:"minner"},(0,r.kt)("span",{parentName:"span",className:"mopen delimcenter",style:{top:"0em"}},"("),(0,r.kt)("span",{parentName:"span",className:"mord mathnormal"},"c"),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2222em"}}),(0,r.kt)("span",{parentName:"span",className:"mbin"},"\xd7"),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2222em"}}),(0,r.kt)("span",{parentName:"span",className:"mord text"},(0,r.kt)("span",{parentName:"span",className:"mord"},"mean")),(0,r.kt)("span",{parentName:"span",className:"mpunct"},","),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.1667em"}}),(0,r.kt)("span",{parentName:"span",className:"mord mathnormal"},"c"),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2222em"}}),(0,r.kt)("span",{parentName:"span",className:"mbin"},"\xd7"),(0,r.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2222em"}}),(0,r.kt)("span",{parentName:"span",className:"mord text"},(0,r.kt)("span",{parentName:"span",className:"mord"},"variance")),(0,r.kt)("span",{parentName:"span",className:"mclose delimcenter",style:{top:"0em"}},")"))))))),(0,r.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"This is a good formula, isn't ot?  It provides a direct way to link the true copy number, which we want to know, to the\ncoverage (accounting for noise in the coverage values), that might allow us to infer copy numbers."))),(0,r.kt)("p",null,"Let's try that now. To make it work:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"We will assume only copy numbers of 0 to 5 are possible (i.e. from a homozygous deletion up to a possible three extra copies).  Feel free to increase this if you want to!"),(0,r.kt)("li",{parentName:"ul"},"We'll put the results in a giant multidimensional array of ",(0,r.kt)("inlineCode",{parentName:"li"},"sites")," x ",(0,r.kt)("inlineCode",{parentName:"li"},"samples")," x ",(0,r.kt)("inlineCode",{parentName:"li"},"copy number states"),".")),(0,r.kt)("p",null,"We start by computing the per-site likelihood of each data point for each possible copy number. Importantly ",(0,r.kt)("em",{parentName:"p"},"we will\ncontinue to work throughout in log space")," to avoid any numerical issues. This makes some computations more difficult,\nbut is a generally good idea when more than a few data points are involved.  So we'll make our array ",(0,r.kt)("em",{parentName:"p"},"an array of\ncopy-number log-likelihoods")," and call it ",(0,r.kt)("inlineCode",{parentName:"p"},"copy.number.lls"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'copy.numbers = 0:5 \ncopy.number.lls = array(\n    NA,                                 # fill with missing data to start\n    dim = c(                            # dimensions\n        nrow  ( sites        ),\n        length( samples      ),\n        length( copy.numbers )\n    ),\n    dimnames = list(                    # A good feature of R is you can name everything\n        sites$position,\n        samples,\n        sprintf( "cf=%d", copy.numbers )\n    )\n)\n')),(0,r.kt)("p",null,"Let's compute these lls:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"for( sample in 1:length(samples) ) {\n    for( i in 1:length(copy.numbers) ) {\n        copy.number = copy.numbers[i]\n        mean.multiplier = copy.number/2\n        variance.multiplier = max( copy.number/2, 0.01 ) # this to be error tolerant, as explained below\n        copy.number.lls[,sample,i] = gaussian.ll(\n            X[,sample],\n            params = list(\n                mean = coverage.parameters$mean[sample] * mean.multiplier,\n                variance = coverage.parameters$variance[sample] * variance.multiplier\n            )\n        )\n        # Handle the missing data sites.\n        # We will just treat missing data as having likelihood 1 (loglikelihood zero) here.\n        copy.number.lls[ is.na(X[,sample]),sample, ] = 0\n    }\n}\n")),(0,r.kt)("p",null,"Look at the top left of the output:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"View( copy.number.lls[1:10,1:10,] )\n")),(0,r.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},'In practice it\'s possible that even sites with zero "real" coverage might get some ',(0,r.kt)("em",{parentName:"p"},"observed")," coverage. This could\nhappen due to spurious read alignment, or mis-alignment, for example."),(0,r.kt)("p",{parentName:"div"},"For this reason we used a ",(0,r.kt)("inlineCode",{parentName:"p"},"variance.multiplier")," variable above.  It equals ",(0,r.kt)("inlineCode",{parentName:"p"},"copy.number / 2")," except for copy number\nzero, where it allows a small amount of coverage to exist."))),(0,r.kt)("p",null,"These copy number log-likelihoods should now capture some of the important signal in the data.  But how to plot it given it's 3-dimensional?  Here are two ways we could do it."),(0,r.kt)("p",null,"We could take the maximum likelihood copy number call and plot that (for each sample and each site)."),(0,r.kt)("p",null,"Or, we could recognise that the above is daft because it doesn't take into account what we know - that most people will be diploid at most sites.  Instead, we could use a Bayesian approach to build this information in."),(0,r.kt)("p",null,"The rest of this practical does both these things.  We'll use this function to plot the results:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-R"},'plot.copy.numbers <- function(\n    copy.number,\n    filename = NULL,\n    title = NULL,\n    palette = c( "darkorange2", "darkgoldenrod1", "forestgreen", "deepskyblue2", "deepskyblue4", "blueviolet" )\n) { \n    if( !is.null( filename )) {\n        pdf( file = filename, width = 6, height = 8 )\n    } \n    par(mfrow=c(1,1))\n    par( mar = c( 4, 4, 2 + 2 *!is.null(title), 2 ) + 0.1 )\n    image( copy.number, x = 1:nrow(copy.number), y = 1:ncol(copy.number), xlab = "sites", ylab = "samples", col = palette, zlim = c( 0, length(palette)-1 ), main = title )\n    legend( "topleft", pch = 22, col = \'black\', pt.bg = palette, legend = c( "hom deletion", "het deletion", "normal", "1 extra copy", "2 extra copies", "3 extra copies" ), bg = "white" )\n    if( !is.null( filename )) {\n        dev.off()\n    }\n}\n')),(0,r.kt)("h2",{id:"copy-number-inference-using-mles"},"Copy number inference using MLEs"),(0,r.kt)("p",null,"Let's use our likelihood function to compute the ",(0,r.kt)("strong",{parentName:"p"},"maximum likelihood copy number state")," for each individual at each site:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'maximum.likelihood.state = array( NA, dim = c( nrow(X), ncol( X ) ), dimnames = list( sites$position, samples ))\nfor( variant in 1:nrow( X )) {\n    for( sample in 1:ncol(X)) {\n        w = which.max( copy.number.lls[variant,sample,] )\n        stopifnot( !is.na(w) )\n        maximum.likelihood.state[variant,sample] = copy.numbers[w]\n    }\n}\n\nplot.copy.numbers( maximum.likelihood.state, title = "Maximum likelihood copy number" )\n')),(0,r.kt)("p",null,"That plot definitely looks cleaner!  Still lots of noise though, can we do better?"))}u.isMDXComponent=!0}}]);